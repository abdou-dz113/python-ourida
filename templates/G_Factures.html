<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='favicon.ico') }}">

    <title>Gestion des Factures</title>
    <style>
    /* ========== VARIABLES & RESET ========== */
    :root {
      --primary: #4d90fe;
      --primary-dark: #357ae8;
      --secondary: #6c757d;
      --secondary-dark: #5a6268;
      --danger: #dc3545;
      --danger-dark: #c82333;
      --success: #28a745;
      --success-dark: #218838;
      --white: #fff;
      --light: #f8f9fa;
      --dark: #333;
      --gray: #ddd;
    }
    .table-responsive {
      background-color: #ffffff65;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
      overflow: hidden;
      margin-top: 20px;
    }

    .lang-switcher {
        padding: 8px 12px;
        border-radius: 4px;
        border: 1px solid #ddd;
        margin-right: 15px;
        background-color: rgb(247, 243, 239);
    }

    /* Pour la langue arabe */
    html[dir="rtl"] body {
        direction: rtl;
        text-align: right;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    /* Actions */
    .action-btn {
        background: none;
        border: none;
        cursor: pointer;
        padding: 8px;
        border-radius: 4px;
        transition: all 0.2s;
    }

    .action-btn:hover {
        background-color: #f1f1f1;
    }

    .btn-edit {
        color: #4d90fe;
    }

    .btn-delete {
        color: #dc3545;
    }

    /* ========== IMAGES ========== */
    .travel-image {
        width: 60px;
        height: 40px;
        object-fit: cover;
        border-radius: 4px;
    }

    /* ========== BASE STYLES ========== */
    body {
        font-family: 'Arial', sans-serif;
        background: url('https://images.unsplash.com/photo-1436491865332-7a61a109cc05?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=2074&q=80') no-repeat center center fixed;
        background-size: cover;
        display: flex;
        justify-content: center;
        align-items: center;
        height: 100vh;
        margin: 0;
        position: relative;
    }

    /* ========== LAYOUT ========== */

    .container {
        max-width: 1200px;
        margin: 0 auto;
        background: rgba(255, 255, 255, 0.5);
        border-radius: 8px;
        box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
        overflow: hidden;
    }

    .header {
        padding: 20px 30px;
        background: linear-gradient(135deg, #6B73FF 0%, #000DFF 100%);
        color: var(--white);
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .header h1 {
        font-size: 20px;
        font-weight: 600;
    }

    .main-content {
        padding: 30px;
    }

    /* ========== SEARCH & FILTERS ========== */
    .search-filter-bar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 25px;
        flex-wrap: wrap;
        gap: 15px;
    }

    .search-box {
        flex: 1;
        min-width: 300px;
        max-width: 500px;
    }

    .search-box input {
        width: 100%;
        padding: 12px 20px;
        border: 1px solid var(--gray);
        border-radius: 6px;
        font-size: 14px;
        transition: all 0.3s;
    }

    .search-box input:focus {
        border-color: var(--primary);
        outline: none;
        box-shadow: 0 0 0 2px rgba(77, 144, 254, 0.2);
    }

    .filter-group {
        display: flex;
        align-items: center;
        gap: 15px;
        flex-wrap: wrap;
    }

    .filter-group label {
        font-weight: 500;
        color: #555;
    }

    .filter-group select {
        padding: 12px 15px;
        border: 1px solid var(--gray);
        border-radius: 6px;
        background-color: var(--white);
        font-size: 14px;
        min-width: 180px;
    }

    /* ========== BUTTONS ========== */
    .btn {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        padding: 12px 20px;
        border: none;
        border-radius: 6px;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s;
    }
    .btn-print {
        color: #6c757d; /* Gris pour impression */
    }
    .action-btn {
        background: none;
        border: none;
        cursor: pointer;
        padding: 8px;
        border-radius: 4px;
        transition: all 0.2s;
    }

    .action-btn:hover {
        background-color: #f1f1f1;
    }

    .btn-edit {
        color: #4d90fe; /* Bleu pour Ã©dition */
    }

    .btn-delete {
        color: #dc3545; /* Rouge pour suppression */
    }
    .btn i {
        margin-right: 8px;
    }

    .btn-primary {
        background-color: #4d90fe;
        color: white;
    }

    .btn-primary:hover {
        background-color: #357ae8;
    }

    .btn-success {
        background-color: #28a745;
        color: white;
    }

    .btn-success:hover {
        background-color: #218838;
    }

    .btn-secondary {
        background-color: var(--secondary);
        color: var(--white);
    }

    .btn-secondary:hover {
        background-color: var(--secondary-dark);
    }

    .btn-danger {
        background-color: var(--danger);
        color: var(--white);
    }

    .btn-danger:hover {
        background-color: var(--danger-dark);
    }

    /* ========== TABLE ========== */
    .table-responsive {
        overflow-x: auto;
        margin-bottom: 25px;
        border-radius: 6px;
        border: 1px solid #eee;
    }

    table {
        width: 100%;
        border-collapse: collapse;
        min-width: 800px;
    }

    th, td {
        padding: 15px;
        text-align: left;
        border-bottom: 1px solid #eee;
    }

    th {
        background-color: var(--light);
        font-weight: 600;
        color: #555;
        text-transform: uppercase;
        font-size: 13px;
        letter-spacing: 0.5px;
    }

    tr:hover {
        background-color: var(--light);
    }

    /* ========== STATUS BADGES ========== */
    .status {
        display: inline-block;
        padding: 6px 12px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 500;
    }

    .status-active {
        background-color: #d4edda;
        color: #155724;
    }

    .status-inactive {
        background-color: #f8d7da;
        color: #721c24;
    }

    .status-pending {
        background-color: #fff3cd;
        color: #856404;
    }

    .status-archived {
        background-color: #e2e3e5;
        color: #383d41;
    }

    /* ========== MODALS ========== */
    .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        z-index: 1000;
        overflow-y: auto;
    }

    .modal-content {
        background-color: var(--white);
        margin: 50px auto;
        border-radius: 8px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        width: 90%;
        max-width: 600px;
        animation: modalopen 0.3s;
    }

    @keyframes modalopen {
        from { opacity: 0; transform: translateY(-20px); }
        to { opacity: 1; transform: translateY(0); }
    }

    .modal-header {
        padding: 20px;
        border-bottom: 1px solid #eee;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .modal-title {
        font-size: 20px;
        font-weight: 600;
    }

    .close-btn {
        background: none;
        border: none;
        font-size: 24px;
        cursor: pointer;
        color: #777;
    }

    .modal-body {
        padding: 20px;
    }

    .modal-footer {
        padding: 20px;
        border-top: 1px solid #eee;
        display: flex;
        justify-content: flex-end;
        gap: 10px;
    }

     .status-badge {
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
            display: inline-block;
        }
        .bg-success {
            background-color: #28a745 !important;
        }
        .bg-warning {
            background-color: #ffc107 !important;
        }
        .bg-danger {
            background-color: #dc3545 !important;
        }
        .text-white {
            color: white !important;
        }
        .text-dark {
            color: #343a40 !important;
        }
        
    /* ========== FORM ELEMENTS ========== */
    .form-group {
        margin-bottom: 20px;
    }

    .form-group label {
        display: block;
        margin-bottom: 8px;
        font-weight: 500;
        color: #555;
    }

    .form-group input,
    .form-group select {
        width: 100%;
        padding: 12px 15px;
        border: 1px solid var(--gray);
        border-radius: 6px;
        font-size: 14px;
        transition: all 0.3s;
    }

    .form-group input:focus,
    .form-group select:focus {
        border-color: var(--primary);
        outline: none;
        box-shadow: 0 0 0 2px rgba(77, 144, 254, 0.2);
    }

    .image-preview {
        margin-top: 10px;
        width: 100px;
        height: 100px;
        border: 1px dashed var(--gray);
        border-radius: 4px;
        display: flex;
        align-items: center;
        justify-content: center;
        overflow: hidden;
    }

    /* ========== RESPONSIVE ========== */
    @media (max-width: 768px) {
        .header {
            flex-direction: column;
            align-items: flex-start;
            gap: 15px;
        }
        
        .search-filter-bar {
            flex-direction: column;
            align-items: stretch;
        }
        
        .search-box {
            max-width: 100%;
        }
        
        .filter-group {
            flex-direction: column;
            align-items: stretch;
            gap: 10px;
        }
        
        .modal-content {
            width: 95%;
            margin: 20px auto;
        }
    }

    .sr-only {
        position: absolute;
        width: 1px;
        height: 1px;
        padding: 0;
        margin: -1px;
        overflow: hidden;
        clip: rect(0, 0, 0, 0);
        white-space: nowrap;
        border-width: 0;
    }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
      <div class="container">
        <div class="header">
            <h1 data-lang="fr">Gestion des Factures</h1>
            <div>
                <select id="langSwitcher" class="lang-switcher">
                    <option value="fr">FR</option>
                    <option value="en">EN</option>
                    <option value="ar">AR</option>
                </select>
                <button id="addInvoiceBtn" class="btn btn-success" data-lang="fr">
                    <i class="fas fa-plus"></i> CrÃ©er une facture
                </button>
                <button id="printAllBtn" class="btn btn-info" data-lang="fr">
                    <i class="fas fa-print"></i> Imprimer toutes les factures
                </button>  
            </div>
        </div>
        
        <div class="main-content">
            <div class="search-filter-bar">
                <div class="search-box">
                    <input type="text" id="searchInput" placeholder="Rechercher factures..." aria-label="Rechercher des factures" data-lang="fr">
                </div>
                <div class="filter-group">
                    <label for="filterSelect" data-lang="fr">Filtrer par statut:</label>
                    <select id="filterSelect" aria-label="Options de filtrage">
                        <option value="all" data-lang="fr">Toutes</option>
                        <option value="paye" data-lang="fr">PayÃ©es</option>
                        <option value="en_attente" data-lang="fr">En attente</option>
                        <option value="en_retard" data-lang="fr">En retard</option>
                    </select>
                </div>
            </div>

            <div class="table-responsive">
                <table id="invoicesTable" aria-describedby="tableDescription">
                    <caption id="tableDescription" class="sr-only">Liste des factures</caption>
                    <thead>
                        <tr>
                            <th scope="col" data-lang="fr">ID</th>
                            <th scope="col" data-lang="fr">Client</th>
                            <th scope="col" data-lang="fr">Date</th>
                            <th scope="col" data-lang="fr">ÃchÃ©ance</th>
                            <th scope="col" data-lang="fr">Total</th>
                            <th scope="col" data-lang="fr">PayÃ©</th>
                            <th scope="col" data-lang="fr">Reste</th>
                            <th scope="col" data-lang="fr">Statut</th>
                            <th scope="col" data-lang="fr">MÃ©thode</th>
                            <th scope="col" data-lang="fr">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="invoicesTableBody">
                        <!-- Contenu dynamique -->
                    </tbody>
                </table>
            </div>
            
            <nav class="pagination" id="pagination" aria-label="Pagination">
                <!-- Pagination dynamique -->
            </nav>
        </div>
    </div>
    <!-- Modal facture -->
    <div id="invoiceModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle" data-lang="fr">Nouvelle Facture</h2>
                <button class="close-btn" aria-label="Fermer la fenÃªtre">&times;</button>
            </div>
            <form id="invoiceForm" enctype="multipart/form-data">
                <div class="modal-body">
                    <input type="hidden" id="invoiceId" name="invoiceId" value="0">
                    
                    <div class="form-row">
                        <div class="form-group col-md-6">
                            <label for="invoiceNumber" data-lang="fr">NumÃ©ro</label>
                            <input type="text" id="invoiceNumber" name="invoiceNumber" required readonly>
                        </div>
                        <div class="form-group col-md-6">
                            <label for="invoiceDate" data-lang="fr">Date</label>
                            <input type="date" id="invoiceDate" name="invoiceDate" required>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="clientName" data-lang="fr">Nom du client</label>
                        <input type="text" id="clientName" name="clientName" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="clientEmail" data-lang="fr">Email du client</label>
                        <input type="email" id="clientEmail" name="clientEmail" required>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group col-md-6">
                            <label for="dueDate" data-lang="fr">Date d'Ã©chÃ©ance</label>
                            <input type="date" id="dueDate" name="dueDate" required>
                        </div>
                        <div class="form-group col-md-6">
                            <label for="paymentMethod" data-lang="fr">MÃ©thode de paiement</label>
                            <select id="paymentMethod" name="paymentMethod">
                                <option value="" data-lang="fr">SÃ©lectionner</option>
                                <option value="carte" data-lang="fr">Carte bancaire</option>
                                <option value="virement" data-lang="fr">Virement</option>
                                <option value="especes" data-lang="fr">EspÃ¨ces</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label data-lang="fr">Articles/Lignes de facture</label>
                        <div id="invoiceItems">
                            <div class="invoice-item row">
                                <div class="col-md-5">
                                    <input type="text" class="form-control item-description" placeholder="Description" data-lang="fr">
                                </div>
                                <div class="col-md-2">
                                    <input type="number" class="form-control item-quantity" placeholder="QtÃ©" min="1" value="1" data-lang="fr">
                                </div>
                                <div class="col-md-3">
                                    <input type="number" class="form-control item-price" placeholder="Prix unitaire" min="0" step="0.01" data-lang="fr">
                                </div>
                                <div class="col-md-2">
                                    <button type="button" class="btn btn-danger remove-item-btn">Ã</button>
                                </div>
                            </div>
                        </div>
                        <button type="button" id="addItemBtn" class="btn btn-sm btn-secondary mt-2" data-lang="fr">
                            <i class="fas fa-plus"></i> Ajouter un article
                        </button>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group col-md-4">
                            <label for="totalAmount" data-lang="fr">Montant total</label>
                            <input type="number" id="totalAmount" name="totalAmount" readonly>
                        </div>
                        <div class="form-group col-md-4">
                            <label for="paidAmount" data-lang="fr">Montant payÃ©</label>
                            <input type="number" id="paidAmount" name="paidAmount" min="0" step="0.01">
                        </div>
                        <div class="form-group col-md-4">
                            <label for="remainingAmount" data-lang="fr">Reste Ã  payer</label>
                            <input type="number" id="remainingAmount" name="remainingAmount" readonly>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="status" data-lang="fr">Statut</label>
                        <select id="status" name="status" required>
                            <option value="en_attente" data-lang="fr">En attente</option>
                            <option value="paye" data-lang="fr">PayÃ©</option>
                            <option value="en_retard" data-lang="fr">En retard</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="notes" data-lang="fr">Notes</label>
                        <textarea id="notes" name="notes" rows="2"></textarea>
                    </div>
                    
                    <div class="form-group form-check">
                        <input type="checkbox" id="sendEmail" name="sendEmail" class="form-check-input" checked>
                        <label for="sendEmail" class="form-check-label" data-lang="fr">Envoyer la facture par email au client</label>
                    </div>
                </div>
                
                <div class="modal-footer">
                    <button type="submit" class="btn btn-primary" data-lang="fr">Enregistrer</button>
                    <button type="button" class="btn btn-secondary" id="cancelBtn" data-lang="fr">Annuler</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal de confirmation -->
    <div id="confirmModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="confirmTitle">
        <div class="modal-content">
            <div class="modal-body">
                <p id="confirmTitle" data-lang="fr">Ãtes-vous sÃ»r de vouloir supprimer cette facture?</p>
            </div>
            <div class="modal-footer">
                <button id="confirmDeleteBtn" class="btn btn-danger" data-lang="fr">Supprimer</button>
                <button id="cancelDeleteBtn" class="btn btn-secondary" data-lang="fr">Annuler</button>
            </div>
        </div>
    </div>

    <!-- Template pour l'impression -->
    <div id="printTemplate" style="display:none;">
        <div class="invoice-print">
            <div class="invoice-header">
                <h1 data-lang="fr">Facture #<span class="invoice-number"></span></h1>
                <div class="invoice-dates">
                    <p data-lang="fr">Date: <span class="invoice-date"></span></p>
                    <p data-lang="fr">ÃchÃ©ance: <span class="invoice-due-date"></span></p>
                </div>
            </div>
            
            <div class="invoice-client">
                <h3 data-lang="fr">Client</h3>
                <p class="client-name"></p>
            </div>
            
            <table class="invoice-items-table">
                <thead>
                    <tr>
                        <th data-lang="fr">Description</th>
                        <th data-lang="fr">QuantitÃ©</th>
                        <th data-lang="fr">Prix unitaire</th>
                        <th data-lang="fr">Total</th>
                    </tr>
                </thead>
                <tbody class="invoice-items-body">
                    <!-- Items will be added here -->
                </tbody>
                <tfoot>
                    <tr>
                        <td colspan="3" class="text-right" data-lang="fr">Total:</td>
                        <td class="invoice-total"></td>
                    </tr>
                    <tr>
                        <td colspan="3" class="text-right" data-lang="fr">Montant payÃ©:</td>
                        <td class="invoice-paid"></td>
                    </tr>
                    <tr>
                        <td colspan="3" class="text-right" data-lang="fr">Reste Ã  payer:</td>
                        <td class="invoice-remaining"></td>
                    </tr>
                </tfoot>
            </table>
            
            <div class="invoice-status">
                <p data-lang="fr">Statut: <span class="invoice-status-text"></span></p>
                <p data-lang="fr">MÃ©thode de paiement: <span class="invoice-method"></span></p>
            </div>
            
            <div class="invoice-notes">
                <h4 data-lang="fr">Notes</h4>
                <p class="invoice-notes-text"></p>
            </div>
        </div>
    </div>
<script>
// Script JavaScript pour la gestion des factures
document.addEventListener('DOMContentLoaded', function() {
    // Variables globales
    let invoices = [];
    let currentInvoiceId = 0;
    
    // Traductions
    const translations = {
        fr: {
            title: "Gestion des Factures",
            createInvoice: "CrÃ©er une facture",
            printAll: "Imprimer toutes les factures",
            searchPlaceholder: "Rechercher factures...",
            filterLabel: "Filtrer par statut:",
            filterAll: "Toutes",
            filterPaid: "PayÃ©es",
            filterPending: "En attente",
            filterLate: "En retard",
            invoiceNumber: "NumÃ©ro",
            client: "Client",
            date: "Date",
            dueDate: "ÃchÃ©ance",
            total: "Total",
            paid: "PayÃ©",
            remaining: "Reste",
            status: "Statut",
            method: "MÃ©thode",
            actions: "Actions",
            newInvoice: "Nouvelle Facture",
            editInvoice: "Modifier Facture",
            clientName: "Nom du client",
            clientEmail: "Email du client",
            paymentMethod: "MÃ©thode de paiement",
            selectMethod: "SÃ©lectionner",
            card: "Carte bancaire",
            transfer: "Virement",
            cash: "EspÃ¨ces",
            items: "Articles/Lignes de facture",
            description: "Description",
            quantity: "QtÃ©",
            unitPrice: "Prix unitaire",
            totalAmount: "Montant total",
            paidAmount: "Montant payÃ©",
            remainingAmount: "Reste Ã  payer",
            notes: "Notes",
            sendEmail: "Envoyer la facture par email au client",
            save: "Enregistrer",
            cancel: "Annuler",
            confirmDelete: "Ãtes-vous sÃ»r de vouloir supprimer cette facture?",
            delete: "Supprimer",
            addItem: "Ajouter un article",
            statusPending: "En attente",
            statusPaid: "PayÃ©",
            statusLate: "En retard",
            invoice: "Facture",
            printInvoice: "Facture #",
            printDate: "Date:",
            printDueDate: "ÃchÃ©ance:",
            printClient: "Client",
            printStatus: "Statut:",
            printPaymentMethod: "MÃ©thode de paiement:",
            printNotes: "Notes",
            printTotal: "Total:",
            printPaid: "Montant payÃ©:",
            printRemaining: "Reste Ã  payer:"
        },
        en: {
            title: "Invoice Management",
            createInvoice: "Create Invoice",
            printAll: "Print All Invoices",
            searchPlaceholder: "Search invoices...",
            filterLabel: "Filter by status:",
            filterAll: "All",
            filterPaid: "Paid",
            filterPending: "Pending",
            filterLate: "Late",
            invoiceNumber: "ID #",
            client: "Client",
            date: "Date",
            dueDate: "Due Date",
            total: "Total",
            paid: "Paid",
            remaining: "Remaining",
            status: "Status",
            method: "Method",
            actions: "Actions",
            newInvoice: "New Invoice",
            editInvoice: "Edit Invoice",
            clientName: "Client Name",
            clientEmail: "Client Email",
            paymentMethod: "Payment Method",
            selectMethod: "Select",
            card: "Credit Card",
            transfer: "Bank Transfer",
            cash: "Cash",
            items: "Items/Invoice Lines",
            description: "Description",
            quantity: "Qty",
            unitPrice: "Unit Price",
            totalAmount: "Total Amount",
            paidAmount: "Paid Amount",
            remainingAmount: "Remaining Amount",
            notes: "Notes",
            sendEmail: "Send invoice by email to client",
            save: "Save",
            cancel: "Cancel",
            confirmDelete: "Are you sure you want to delete this invoice?",
            delete: "Delete",
            addItem: "Add Item",
            statusPending: "Pending",
            statusPaid: "Paid",
            statusLate: "Late",
            invoice: "Invoice",
            printInvoice: "Invoice #",
            printDate: "Date:",
            printDueDate: "Due Date:",
            printClient: "Client",
            printStatus: "Status:",
            printPaymentMethod: "Payment Method:",
            printNotes: "Notes",
            printTotal: "Total:",
            printPaid: "Paid Amount:",
            printRemaining: "Remaining Amount:"
        },
        ar: {
            title: "Ø¥Ø¯Ø§Ø±Ø© Ø§ÙÙÙØ§ØªÙØ±",
            createInvoice: "Ø¥ÙØ´Ø§Ø¡ ÙØ§ØªÙØ±Ø©",
            printAll: "Ø·Ø¨Ø§Ø¹Ø© Ø¬ÙÙØ¹ Ø§ÙÙÙØ§ØªÙØ±",
            searchPlaceholder: "Ø¨Ø­Ø« Ø§ÙÙÙØ§ØªÙØ±...",
            filterLabel: "ØªØµÙÙØ© Ø­Ø³Ø¨ Ø§ÙØ­Ø§ÙØ©:",
            filterAll: "Ø§ÙÙÙ",
            filterPaid: "ÙØ¯ÙÙØ¹Ø©",
            filterPending: "ÙÙØ¯ Ø§ÙØ§ÙØªØ¸Ø§Ø±",
            filterLate: "ÙØªØ£Ø®Ø±Ø©",
            invoiceNumber: "Ø±ÙÙ",
            client: "Ø§ÙØ¹ÙÙÙ",
            date: "Ø§ÙØªØ§Ø±ÙØ®",
            dueDate: "ØªØ§Ø±ÙØ® Ø§ÙØ§Ø³ØªØ­ÙØ§Ù",
            total: "Ø§ÙÙØ¬ÙÙØ¹",
            paid: "Ø§ÙÙØ¯ÙÙØ¹",
            remaining: "Ø§ÙÙØªØ¨ÙÙ",
            status: "Ø§ÙØ­Ø§ÙØ©",
            method: "Ø·Ø±ÙÙØ© Ø§ÙØ¯ÙØ¹",
            actions: "Ø§ÙØ¥Ø¬Ø±Ø§Ø¡Ø§Øª",
            newInvoice: "ÙØ§ØªÙØ±Ø© Ø¬Ø¯ÙØ¯Ø©",
            editInvoice: "ØªØ¹Ø¯ÙÙ Ø§ÙÙØ§ØªÙØ±Ø©",
            clientName: "Ø§Ø³Ù Ø§ÙØ¹ÙÙÙ",
            clientEmail: "Ø¨Ø±ÙØ¯ Ø§ÙØ¹ÙÙÙ",
            paymentMethod: "Ø·Ø±ÙÙØ© Ø§ÙØ¯ÙØ¹",
            selectMethod: "Ø§Ø®ØªØ±",
            card: "Ø¨Ø·Ø§ÙØ© Ø§Ø¦ØªÙØ§Ù",
            transfer: "Ø­ÙØ§ÙØ© Ø¨ÙÙÙØ©",
            cash: "ÙÙØ¯Ø§Ù",
            items: "Ø§ÙØ¨ÙÙØ¯/Ø¨ÙÙØ¯ Ø§ÙÙØ§ØªÙØ±Ø©",
            description: "Ø§ÙÙØµÙ",
            quantity: "Ø§ÙÙÙÙØ©",
            unitPrice: "Ø³Ø¹Ø± Ø§ÙÙØ­Ø¯Ø©",
            totalAmount: "Ø§ÙÙØ¨ÙØº Ø§ÙØ¥Ø¬ÙØ§ÙÙ",
            paidAmount: "Ø§ÙÙØ¨ÙØº Ø§ÙÙØ¯ÙÙØ¹",
            remainingAmount: "Ø§ÙÙØ¨ÙØº Ø§ÙÙØªØ¨ÙÙ",
            notes: "ÙÙØ§Ø­Ø¸Ø§Øª",
            sendEmail: "Ø¥Ø±Ø³Ø§Ù Ø§ÙÙØ§ØªÙØ±Ø© Ø¨Ø§ÙØ¨Ø±ÙØ¯ Ø§ÙØ¥ÙÙØªØ±ÙÙÙ Ø¥ÙÙ Ø§ÙØ¹ÙÙÙ",
            save: "Ø­ÙØ¸",
            cancel: "Ø¥ÙØºØ§Ø¡",
            confirmDelete: "ÙÙ Ø£ÙØª ÙØªØ£ÙØ¯ Ø£ÙÙ ØªØ±ÙØ¯ Ø­Ø°Ù ÙØ°Ù Ø§ÙÙØ§ØªÙØ±Ø©Ø",
            delete: "Ø­Ø°Ù",
            addItem: "Ø¥Ø¶Ø§ÙØ© Ø¨ÙØ¯",
            statusPending: "ÙÙØ¯ Ø§ÙØ§ÙØªØ¸Ø§Ø±",
            statusPaid: "ÙØ¯ÙÙØ¹Ø©",
            statusLate: "ÙØªØ£Ø®Ø±Ø©",
            invoice: "ÙØ§ØªÙØ±Ø©",
            printInvoice: "ÙØ§ØªÙØ±Ø© Ø±ÙÙ #",
            printDate: "Ø§ÙØªØ§Ø±ÙØ®:",
            printDueDate: "ØªØ§Ø±ÙØ® Ø§ÙØ§Ø³ØªØ­ÙØ§Ù:",
            printClient: "Ø§ÙØ¹ÙÙÙ",
            printStatus: "Ø§ÙØ­Ø§ÙØ©:",
            printPaymentMethod: "Ø·Ø±ÙÙØ© Ø§ÙØ¯ÙØ¹:",
            printNotes: "ÙÙØ§Ø­Ø¸Ø§Øª",
            printTotal: "Ø§ÙÙØ¬ÙÙØ¹:",
            printPaid: "Ø§ÙÙØ¨ÙØº Ø§ÙÙØ¯ÙÙØ¹:",
            printRemaining: "Ø§ÙÙØ¨ÙØº Ø§ÙÙØªØ¨ÙÙ:"
        }
    };
    
    // Initialisation
    init();
    
    function init() {
        loadInvoices();
        
        // Gestionnaires d'Ã©vÃ©nements
        document.getElementById('addInvoiceBtn').addEventListener('click', showAddInvoiceModal);
        document.getElementById('printAllBtn').addEventListener('click', printAllInvoices);
        document.getElementById('searchInput').addEventListener('input', filterInvoices);
        document.getElementById('filterSelect').addEventListener('change', filterInvoices);
        document.getElementById('invoiceForm').addEventListener('submit', saveInvoice);
        document.getElementById('cancelBtn').addEventListener('click', closeModal);
        document.querySelector('.close-btn').addEventListener('click', closeModal);
        document.getElementById('confirmDeleteBtn').addEventListener('click', confirmDelete);
        document.getElementById('cancelDeleteBtn').addEventListener('click', closeConfirmModal);
        document.getElementById('addItemBtn').addEventListener('click', addInvoiceItem);
        document.getElementById('langSwitcher').addEventListener('change', changeLanguage);
        
        // Ãcouteurs pour les calculs dynamiques
        document.getElementById('paidAmount').addEventListener('input', calculateRemaining);
        document.getElementById('invoiceItems').addEventListener('input', function(e) {
            if (e.target.classList.contains('item-quantity') || e.target.classList.contains('item-price')) {
                calculateTotal();
            }
        });
        
        generateInvoiceNumber();
        changeLanguage();
    }
    
    function generateNewId() {
        return invoices.length > 0 ? Math.max(...invoices.map(inv => parseInt(inv.id))) + 1 : 1;
    }
    
    function loadInvoices() {
        const savedInvoices = localStorage.getItem('invoices');
        if (savedInvoices) {
            invoices = JSON.parse(savedInvoices);
            invoices = invoices.map(invoice => {
                return {
                    ...invoice,
                    id: parseInt(invoice.id),
                    number: invoice.number || `FAC-${invoice.id.toString().padStart(5, '0')}`,
                    clientName: invoice.clientName || 'Client non spÃ©cifiÃ©'
                };
            });
        } else {
            // DonnÃ©es initiales correspondant Ã  l'image
            invoices = [
                {
                    id: 1,
                    number: 'FAC-2023-001',
                    clientName: 'Mohamed Zerrouki',
                    clientEmail: 'Mohamedzerrouki@gmail.com',
                    date: '2025-01-15',
                    dueDate: '2025-05-15',
                    items: [
                        { description: 'Service 1', quantity: 2, price: 100 },
                        { description: 'Service 2', quantity: 1, price: 150 }
                    ],
                    totalAmount: 350,
                    paidAmount: 350,
                    remainingAmount: 0,
                    status: 'paye',
                    paymentMethod: 'carte',
                    notes: 'Facture payÃ©e Ã  temps'
                },
                {
                    id: 2,
                    number: 'FAC-2023-002',
                    clientName: 'Amina Houari',
                    clientEmail: 'a.hou@gmail.com',
                    date: '2025-02-01',
                    dueDate: '2025-07-01',
                    items: [
                        { description: 'Service 3', quantity: 3, price: 75 }
                    ],
                    totalAmount: 225,
                    paidAmount: 100,
                    remainingAmount: 125,
                    status: 'en_attente',
                    paymentMethod: 'especes',
                    notes: 'Acompte reÃ§u'
                }
            ];
        }
        
        renderInvoices();
    }
    
    function renderInvoices() {
        const tableBody = document.getElementById('invoicesTableBody');
        tableBody.innerHTML = '';
        
        const lang = document.getElementById('langSwitcher').value;
        
        invoices.forEach(invoice => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${invoice.number}</td>
                <td>${invoice.clientName}</td>
                <td>${formatDate(invoice.date, lang)}</td>
                <td>${formatDate(invoice.dueDate, lang)}</td>
                <td>${formatCurrency(invoice.totalAmount, lang)}</td>
                <td>${formatCurrency(invoice.paidAmount, lang)}</td>
                <td>${formatCurrency(invoice.remainingAmount, lang)}</td>
                <td><span class="status-badge ${getStatusClass(invoice.status)}">${getStatusText(invoice.status, lang)}</span></td>
                <td>${getMethodText(invoice.paymentMethod, lang)}</td>
                <td>
                    <button class="btn btn-sm btn-primary edit-btn" data-id="${invoice.id}">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="btn btn-sm btn-danger delete-btn" data-id="${invoice.id}">
                        <i class="fas fa-trash"></i>
                    </button>
                    <button class="btn btn-sm btn-info print-btn" data-id="${invoice.id}">
                        <i class="fas fa-print"></i>
                    </button>
                </td>
            `;
            tableBody.appendChild(row);
        });
        
        document.querySelectorAll('.edit-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                editInvoice(parseInt(this.getAttribute('data-id')));
            });
        });
        
        document.querySelectorAll('.delete-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                showConfirmModal(parseInt(this.getAttribute('data-id')));
            });
        });
        
        document.querySelectorAll('.print-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                printInvoice(parseInt(this.getAttribute('data-id')));
            });
        });
    }
    
    function showAddInvoiceModal() {
        currentInvoiceId = 0;
        const lang = document.getElementById('langSwitcher').value;
        document.getElementById('modalTitle').textContent = translations[lang].newInvoice;
        document.getElementById('invoiceForm').reset();
        document.getElementById('invoiceId').value = "0";
        generateInvoiceNumber();
        document.getElementById('invoiceDate').valueAsDate = new Date();
        
        const itemsContainer = document.getElementById('invoiceItems');
        itemsContainer.innerHTML = '';
        addInvoiceItem();
        
        calculateTotal();
        document.getElementById('invoiceModal').style.display = 'block';
    }
    
    function editInvoice(id) {
        const invoice = invoices.find(inv => inv.id === parseInt(id));
        if (!invoice) return;
        
        currentInvoiceId = parseInt(id);
        const lang = document.getElementById('langSwitcher').value;
        document.getElementById('modalTitle').textContent = translations[lang].editInvoice;
        
        document.getElementById('invoiceId').value = invoice.id;
        document.getElementById('invoiceNumber').value = invoice.number;
        document.getElementById('clientName').value = invoice.clientName || '';
        document.getElementById('clientEmail').value = invoice.clientEmail || '';
        document.getElementById('invoiceDate').value = invoice.date;
        document.getElementById('dueDate').value = invoice.dueDate;
        document.getElementById('totalAmount').value = invoice.totalAmount;
        document.getElementById('paidAmount').value = invoice.paidAmount;
        document.getElementById('remainingAmount').value = invoice.remainingAmount;
        document.getElementById('status').value = invoice.status;
        document.getElementById('paymentMethod').value = invoice.paymentMethod;
        document.getElementById('notes').value = invoice.notes || '';
        
        const itemsContainer = document.getElementById('invoiceItems');
        itemsContainer.innerHTML = '';
        
        invoice.items.forEach(item => {
            const itemDiv = document.createElement('div');
            itemDiv.className = 'invoice-item row';
            itemDiv.innerHTML = `
                <div class="col-md-5">
                    <input type="text" class="form-control item-description" placeholder="${translations[lang].description}" value="${item.description}">
                </div>
                <div class="col-md-2">
                    <input type="number" class="form-control item-quantity" placeholder="${translations[lang].quantity}" min="1" value="${item.quantity}">
                </div>
                <div class="col-md-3">
                    <input type="number" class="form-control item-price" placeholder="${translations[lang].unitPrice}" min="0" step="0.01" value="${item.price}">
                </div>
                <div class="col-md-2">
                    <button type="button" class="btn btn-danger remove-item-btn">Ã</button>
                </div>
            `;
            itemsContainer.appendChild(itemDiv);
            
            itemDiv.querySelector('.remove-item-btn').addEventListener('click', function() {
                itemDiv.remove();
                calculateTotal();
            });
        });
        
        document.getElementById('invoiceModal').style.display = 'block';
    }
    
    function saveInvoice(e) {
        e.preventDefault();
        
        const items = [];
        document.querySelectorAll('.invoice-item').forEach(itemDiv => {
            const description = itemDiv.querySelector('.item-description').value;
            const quantity = parseFloat(itemDiv.querySelector('.item-quantity').value);
            const price = parseFloat(itemDiv.querySelector('.item-price').value);
            
            if (description && !isNaN(quantity) && !isNaN(price)) {
                items.push({
                    description,
                    quantity,
                    price
                });
            }
        });
        
        if (items.length === 0) {
            const lang = document.getElementById('langSwitcher').value;
            alert(lang === 'fr' ? 'Ajoutez au moins un article Ã  la facture' : 
                  lang === 'en' ? 'Add at least one item to the invoice' : 
                  'Ø£Ø¶Ù Ø¹ÙØµØ±ÙØ§ ÙØ§Ø­Ø¯ÙØ§ Ø¹ÙÙ Ø§ÙØ£ÙÙ Ø¥ÙÙ Ø§ÙÙØ§ØªÙØ±Ø©');
            return;
        }
        
        const totalAmount = parseFloat(document.getElementById('totalAmount').value);
        const paidAmount = parseFloat(document.getElementById('paidAmount').value) || 0;
        const remainingAmount = totalAmount - paidAmount;
        
        const invoiceId = parseInt(document.getElementById('invoiceId').value) || generateNewId();
        
        const invoiceData = {
            id: invoiceId,
            number: document.getElementById('invoiceNumber').value || `FAC-${invoiceId.toString().padStart(5, '0')}`,
            clientName: document.getElementById('clientName').value || 'Non spÃ©cifiÃ©',
            clientEmail: document.getElementById('clientEmail').value,
            date: document.getElementById('invoiceDate').value,
            dueDate: document.getElementById('dueDate').value,
            items,
            totalAmount,
            paidAmount,
            remainingAmount,
            status: document.getElementById('status').value,
            paymentMethod: document.getElementById('paymentMethod').value,
            notes: document.getElementById('notes').value
        };
        
        if (currentInvoiceId > 0) {
            const index = invoices.findIndex(inv => inv.id === currentInvoiceId);
            if (index !== -1) {
                invoices[index] = invoiceData;
            }
        } else {
            invoices.push(invoiceData);
        }
        
        if (document.getElementById('sendEmail').checked) {
            sendInvoiceByEmail(invoiceData);
        }
        
        saveInvoicesToStorage();
        closeModal();
        renderInvoices();
    }
    
    function generateInvoiceNumber() {
        const now = new Date();
        const year = now.getFullYear();
        const month = String(now.getMonth() + 1).padStart(2, '0');
        const day = String(now.getDate()).padStart(2, '0');
        const count = invoices.filter(inv => inv.date && inv.date.startsWith(`${year}-${month}-${day}`)).length + 1;
        
        document.getElementById('invoiceNumber').value = `FAC-${year}${month}${day}-${String(count).padStart(3, '0')}`;
    }
    
    function showConfirmModal(id) {
        currentInvoiceId = parseInt(id);
        document.getElementById('confirmModal').style.display = 'block';
    }
    
    function confirmDelete() {
        invoices = invoices.filter(inv => inv.id !== currentInvoiceId);
        saveInvoicesToStorage();
        closeConfirmModal();
        renderInvoices();
    }
    
    function addInvoiceItem() {
        const lang = document.getElementById('langSwitcher').value;
        const itemsContainer = document.getElementById('invoiceItems');
        const itemDiv = document.createElement('div');
        itemDiv.className = 'invoice-item row';
        itemDiv.innerHTML = `
            <div class="col-md-5">
                <input type="text" class="form-control item-description" placeholder="${translations[lang].description}">
            </div>
            <div class="col-md-2">
                <input type="number" class="form-control item-quantity" placeholder="${translations[lang].quantity}" min="1" value="1">
            </div>
            <div class="col-md-3">
                <input type="number" class="form-control item-price" placeholder="${translations[lang].unitPrice}" min="0" step="0.01">
            </div>
            <div class="col-md-2">
                <button type="button" class="btn btn-danger remove-item-btn">Ã</button>
            </div>
        `;
        itemsContainer.appendChild(itemDiv);
        
        itemDiv.querySelector('.remove-item-btn').addEventListener('click', function() {
            itemDiv.remove();
            calculateTotal();
        });
    }
    
    function calculateTotal() {
        let total = 0;
        
        document.querySelectorAll('.invoice-item').forEach(itemDiv => {
            const quantity = parseFloat(itemDiv.querySelector('.item-quantity').value) || 0;
            const price = parseFloat(itemDiv.querySelector('.item-price').value) || 0;
            total += quantity * price;
        });
        
        document.getElementById('totalAmount').value = total.toFixed(2);
        calculateRemaining();
    }
    
    function calculateRemaining() {
        const total = parseFloat(document.getElementById('totalAmount').value) || 0;
        const paid = parseFloat(document.getElementById('paidAmount').value) || 0;
        const remaining = total - paid;
        
        document.getElementById('remainingAmount').value = remaining.toFixed(2);
        
        const statusSelect = document.getElementById('status');
        if (remaining <= 0) {
            statusSelect.value = 'paye';
        } else {
            const dueDate = new Date(document.getElementById('dueDate').value);
            const today = new Date();
            if (dueDate < today) {
                statusSelect.value = 'en_retard';
            } else {
                statusSelect.value = 'en_attente';
            }
        }
    }
    
    function closeModal() {
        document.getElementById('invoiceModal').style.display = 'none';
    }
    
    function closeConfirmModal() {
        document.getElementById('confirmModal').style.display = 'none';
    }
    
    function filterInvoices() {
        const searchTerm = document.getElementById('searchInput').value.toLowerCase();
        const filterValue = document.getElementById('filterSelect').value;
        
        const filteredInvoices = invoices.filter(invoice => {
            const matchesSearch = invoice.number.toLowerCase().includes(searchTerm) || 
                                 (invoice.clientName && invoice.clientName.toLowerCase().includes(searchTerm));
            
            const matchesFilter = filterValue === 'all' || 
                                (filterValue === 'paye' && invoice.status === 'paye') ||
                                (filterValue === 'en_attente' && invoice.status === 'en_attente') ||
                                (filterValue === 'en_retard' && invoice.status === 'en_retard');
            
            return matchesSearch && matchesFilter;
        });
        
        renderFilteredInvoices(filteredInvoices);
    }
    
    function renderFilteredInvoices(filteredInvoices) {
        const tableBody = document.getElementById('invoicesTableBody');
        tableBody.innerHTML = '';
        
        const lang = document.getElementById('langSwitcher').value;
        
        filteredInvoices.forEach(invoice => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${invoice.number}</td>
                <td>${invoice.clientName}</td>
                <td>${formatDate(invoice.date, lang)}</td>
                <td>${formatDate(invoice.dueDate, lang)}</td>
                <td>${formatCurrency(invoice.totalAmount, lang)}</td>
                <td>${formatCurrency(invoice.paidAmount, lang)}</td>
                <td>${formatCurrency(invoice.remainingAmount, lang)}</td>
                <td><span class="status-badge ${getStatusClass(invoice.status)}">${getStatusText(invoice.status, lang)}</span></td>
                <td>${getMethodText(invoice.paymentMethod, lang)}</td>
                <td>
                    <button class="btn btn-sm btn-primary edit-btn" data-id="${invoice.id}">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="btn btn-sm btn-danger delete-btn" data-id="${invoice.id}">
                        <i class="fas fa-trash"></i>
                    </button>
                    <button class="btn btn-sm btn-info print-btn" data-id="${invoice.id}">
                        <i class="fas fa-print"></i>
                    </button>
                </td>
            `;
            tableBody.appendChild(row);
        });
        
        document.querySelectorAll('.edit-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                editInvoice(parseInt(this.getAttribute('data-id')));
            });
        });
        
        document.querySelectorAll('.delete-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                showConfirmModal(parseInt(this.getAttribute('data-id')));
            });
        });
        
        document.querySelectorAll('.print-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                printInvoice(parseInt(this.getAttribute('data-id')));
            });
        });
    }
    
    function printInvoice(id) {
        const invoice = invoices.find(inv => inv.id === id);
        if (!invoice) return;
        
        const lang = document.getElementById('langSwitcher').value;
        const printTemplate = document.getElementById('printTemplate');
        const clone = printTemplate.cloneNode(true);
        clone.style.display = 'block';
        clone.id = 'printTemplateClone';
        
        clone.querySelector('.invoice-number').textContent = invoice.number;
        clone.querySelector('.invoice-date').textContent = formatDate(invoice.date, lang);
        clone.querySelector('.invoice-due-date').textContent = formatDate(invoice.dueDate, lang);
        clone.querySelector('.client-name').textContent = invoice.clientName || translations[lang].clientName;
        
        const itemsBody = clone.querySelector('.invoice-items-body');
        itemsBody.innerHTML = '';
        
        invoice.items.forEach(item => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${item.description}</td>
                <td>${item.quantity}</td>
                <td>${formatCurrency(item.price, lang)}</td>
                <td>${formatCurrency(item.quantity * item.price, lang)}</td>
            `;
            itemsBody.appendChild(row);
        });
        
        clone.querySelector('.invoice-total').textContent = formatCurrency(invoice.totalAmount, lang);
        clone.querySelector('.invoice-paid').textContent = formatCurrency(invoice.paidAmount, lang);
        clone.querySelector('.invoice-remaining').textContent = formatCurrency(invoice.remainingAmount, lang);
        clone.querySelector('.invoice-status-text').textContent = getStatusText(invoice.status, lang);
        clone.querySelector('.invoice-method').textContent = getMethodText(invoice.paymentMethod, lang);
        clone.querySelector('.invoice-notes-text').textContent = invoice.notes || (lang === 'fr' ? 'Aucune note' : lang === 'en' ? 'No notes' : 'ÙØ§ ØªÙØ¬Ø¯ ÙÙØ§Ø­Ø¸Ø§Øª');
        
        clone.querySelectorAll('[data-lang]').forEach(element => {
            const key = element.getAttribute('data-lang');
            if (translations[lang] && translations[lang][key]) {
                element.textContent = translations[lang][key];
            }
        });
        
        document.body.appendChild(clone);
        window.print();
        document.body.removeChild(clone);
    }
    
    function printAllInvoices() {
        const lang = document.getElementById('langSwitcher').value;
        const printWindow = window.open('', '_blank');
        printWindow.document.write(`
            <html>
                <head>
                    <title>${translations[lang].printAll}</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 20px; }
                        .invoice { page-break-after: always; margin-bottom: 40px; }
                        .invoice:last-child { page-break-after: auto; }
                        h1 { color: #333; }
                        table { width: 100%; border-collapse: collapse; margin: 20px 0; }
                        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
                        th { background-color: #f2f2f2; }
                        .text-right { text-align: right; }
                        .status-badge { 
                            padding: 3px 8px; 
                            border-radius: 3px; 
                            font-size: 12px; 
                            font-weight: bold; 
                        }
                        .paye { background-color: #d4edda; color: #155724; }
                        .en_attente { background-color: #fff3cd; color: #856404; }
                        .en_retard { background-color: #f8d7da; color: #721c24; }
                    </style>
                </head>
                <body>
                    <h1>${translations[lang].printAll}</h1>
        `);
        
        invoices.forEach(invoice => {
            printWindow.document.write(`
                <div class="invoice">
                    <h2>${translations[lang].invoice} ${invoice.number}</h2>
                    <p><strong>${translations[lang].client}:</strong> ${invoice.clientName || translations[lang].clientName}</p>
                    <p><strong>${translations[lang].date}:</strong> ${formatDate(invoice.date, lang)}</p>
                    <p><strong>${translations[lang].dueDate}:</strong> ${formatDate(invoice.dueDate, lang)}</p>
                    
                    <table>
                        <thead>
                            <tr>
                                <th>${translations[lang].description}</th>
                                <th>${translations[lang].quantity}</th>
                                <th>${translations[lang].unitPrice}</th>
                                <th>${translations[lang].total}</th>
                            </tr>
                        </thead>
                        <tbody>
            `);
            
            invoice.items.forEach(item => {
                printWindow.document.write(`
                    <tr>
                        <td>${item.description}</td>
                        <td>${item.quantity}</td>
                        <td>${formatCurrency(item.price, lang)}</td>
                        <td>${formatCurrency(item.quantity * item.price, lang)}</td>
                    </tr>
                `);
            });
            
            printWindow.document.write(`
                        </tbody>
                        <tfoot>
                            <tr>
                                <td colspan="3" class="text-right"><strong>${translations[lang].total}:</strong></td>
                                <td>${formatCurrency(invoice.totalAmount, lang)}</td>
                            </tr>
                            <tr>
                                <td colspan="3" class="text-right"><strong>${translations[lang].paid}:</strong></td>
                                <td>${formatCurrency(invoice.paidAmount, lang)}</td>
                            </tr>
                            <tr>
                                <td colspan="3" class="text-right"><strong>${translations[lang].remaining}:</strong></td>
                                <td>${formatCurrency(invoice.remainingAmount, lang)}</td>
                            </tr>
                        </tfoot>
                    </table>
                    
                    <p><strong>${translations[lang].status}:</strong> <span class="status-badge ${getStatusClass(invoice.status)}">${getStatusText(invoice.status, lang)}</span></p>
                    <p><strong>${translations[lang].method}:</strong> ${getMethodText(invoice.paymentMethod, lang)}</p>
                    <p><strong>${translations[lang].notes}:</strong> ${invoice.notes || (lang === 'fr' ? 'Aucune note' : lang === 'en' ? 'No notes' : 'ÙØ§ ØªÙØ¬Ø¯ ÙÙØ§Ø­Ø¸Ø§Øª')}</p>
                </div>
            `);
        });
        
        printWindow.document.write(`
                </body>
            </html>
        `);
        
        printWindow.document.close();
        printWindow.print();
    }
    
    function sendInvoiceByEmail(invoice) {
        const lang = document.getElementById('langSwitcher').value;
        const message = lang === 'fr' ? 
            `Envoi de la facture ${invoice.number} Ã  ${invoice.clientEmail}` : 
            lang === 'en' ? 
            `Sending invoice ${invoice.number} to ${invoice.clientEmail}` : 
            `Ø¥Ø±Ø³Ø§Ù Ø§ÙÙØ§ØªÙØ±Ø© ${invoice.number} Ø¥ÙÙ ${invoice.clientEmail}`;
        
        console.log(message);
        alert(message);
    }
    
    function saveInvoicesToStorage() {
        localStorage.setItem('invoices', JSON.stringify(invoices));
    }
    
    function changeLanguage() {
        const lang = document.getElementById('langSwitcher').value;
        
        document.querySelectorAll('[data-lang]').forEach(element => {
            const key = element.getAttribute('data-lang');
            if (translations[lang] && translations[lang][key]) {
                if (element.tagName === 'INPUT' || element.tagName === 'TEXTAREA') {
                    element.placeholder = translations[lang][key];
                } else {
                    element.textContent = translations[lang][key];
                }
            }
        });
        
        renderInvoices();
    }
    
    function formatDate(dateString, lang) {
        if (!dateString) return '';
        
        const date = new Date(dateString);
        const options = { 
            year: 'numeric', 
            month: 'short', 
            day: 'numeric',
            ...(lang === 'ar' ? { calendar: 'gregory', numberingSystem: 'arab' } : {})
        };
        
        // Formatage spÃ©cifique pour le franÃ§ais
        if (lang === 'fr') {
            const months = {
                'jan': 'janv.', 'fÃ©v': 'fÃ©vr.', 'mar': 'mars', 
                'avr': 'avr.', 'mai': 'mai', 'jun': 'juin',
                'jul': 'juil.', 'aoÃ»': 'aoÃ»t', 'sep': 'sept.',
                'oct': 'oct.', 'nov': 'nov.', 'dÃ©c': 'dÃ©c.'
            };
            
            let formatted = date.toLocaleDateString('fr-FR', options);
            // Remplacer les noms de mois abrÃ©gÃ©s
            for (const [key, value] of Object.entries(months)) {
                formatted = formatted.replace(key, value);
            }
            return formatted;
        }
        
        return date.toLocaleDateString(lang === 'en' ? 'en-US' : 'ar-EG', options);
    }
    
    function formatCurrency(amount, lang) {
        if (isNaN(amount)) return '';
        return new Intl.NumberFormat(
            lang === 'fr' ? 'fr-FR' : lang === 'en' ? 'en-US' : 'ar-EG', 
            { 
                style: 'decimal',
                minimumFractionDigits: 2,
                maximumFractionDigits: 2,
                ...(lang === 'ar' ? { numberingSystem: 'arab' } : {})
            }
        ).format(amount) + ' DA';
    }
    
    function getStatusText(status, lang) {
        switch(status) {
            case 'paye': return translations[lang].statusPaid;
            case 'en_attente': return translations[lang].statusPending;
            case 'en_retard': return translations[lang].statusLate;
            default: return status;
        }
    }
    
    function getStatusClass(status) {
        switch(status) {
            case 'paye': return 'paye bg-success text-white';
            case 'en_attente': return 'en_attente bg-warning text-dark';
            case 'en_retard': return 'en_retard bg-danger text-white';
            default: return '';
        }
    }
    
    function getMethodText(method, lang) {
        switch(method) {
            case 'carte': return translations[lang].card;
            case 'virement': return translations[lang].transfer;
            case 'especes': return translations[lang].cash;
            default: return method || translations[lang].selectMethod;
        }
    }
});
</script>
</body>
</html>